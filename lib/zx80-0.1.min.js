/**

ZX Javascript

Copyright 2017.
Steven Goodwin. 

This file is released under the GNU General Public License Version 3.

Please see the licensing conditions for details.

The latest version is generally available at:
	https://github.com/marquisdegeek/zxjavascript

See it at:
	https://marquisdegeek.com/code_zxjavascript
*/
var zx={};
zx.rom=[33,255,127,62,63,195,97,2,225,110,253,203,0,126,24,3,195,96,5,200,253,117,0,201,24,56,42,38,64,126,167,192,205,82,0,24,249,205,85,0,205,26,0,6,0,195,225,9,205,79,9,208,197,195,243,12,13,194,69,0,225,5,200,203,217,237,79,251,233,209,200,24,248,205,37,0,126,254,217,194,174,8,42,38,64,35,34,38,64,126,254,176,192,34,4,64,253,203,25,126,40,239,253,203,1,214,24,233,63,61,40,59,38,56,41,43,44,54,60,42,55,57,29,30,31,32,33,28,37,36,35,34,53,52,46,58,62,118,49,48,47,45,0,27,50,51,39,14,215,15,223,
9,8,6,7,11,2,3,4,5,10,219,224,213,214,114,119,116,115,112,113,222,217,218,13,1,117,227,221,220,226,12,216,228,229,225,212,143,129,57,45,42,179,57,180,153,154,145,144,51,52,185,146,147,148,149,38,51,169,52,183,20,148,150,151,152,49,46,56,185,55,42,57,58,55,179,40,49,184,41,46,178,56,38,59,170,43,52,183,44,52,0,57,180,53,52,48,170,46,51,53,58,185,55,38,51,41,52,50,46,56,170,49,42,185,143,143,51,42,61,185,53,55,46,51,185,143,51,42,188,55,58,179,56,57,52,181,40,52,51,57,46,51,58,170,46,171,44,52,0,56,
58,167,49,52,38,169,40,49,42,38,183,55,42,178,143,205,173,1,6,8,16,254,42,30,64,35,34,30,64,33,255,255,6,254,72,237,120,246,1,246,224,87,47,254,1,159,176,165,111,124,162,103,203,0,237,120,56,237,31,203,20,23,23,23,159,230,24,198,32,50,35,64,237,75,38,64,34,38,64,120,198,2,237,66,235,33,34,64,126,178,179,200,120,254,254,159,6,31,182,160,31,119,5,16,254,211,255,62,236,6,25,42,12,64,203,252,205,173,1,62,243,4,43,253,53,35,24,143,253,78,35,237,79,62,221,251,233,209,17,203,18,62,127,219,254,31,48,66,16,
254,27,122,179,32,242,33,0,64,17,8,248,203,6,159,230,5,198,4,79,211,255,6,36,16,254,62,127,219,254,6,35,16,254,13,32,239,66,0,16,253,22,254,29,32,222,31,48,16,205,248,1,24,211,35,235,42,10,64,55,237,82,235,208,225,195,131,2,209,17,18,87,62,127,219,254,31,48,242,23,23,56,242,27,122,179,32,240,253,52,11,33,0,64,30,8,62,127,219,254,31,48,36,23,23,48,245,14,148,6,26,13,219,254,23,203,121,121,56,245,16,245,32,4,254,86,48,224,63,203,22,29,32,218,205,248,1,24,211,21,242,0,0,253,53,11,24,173,203,184,203,
176,237,67,6,64,193,24,34,54,1,43,188,32,250,35,53,40,252,249,245,62,14,237,71,237,86,253,33,0,64,33,40,64,34,8,64,54,128,35,34,10,64,42,10,64,54,176,35,54,118,35,34,12,64,253,54,18,2,205,71,7,235,120,253,150,18,56,90,60,71,217,42,6,64,237,91,19,64,237,82,235,48,4,25,34,19,64,205,10,6,30,0,205,247,4,56,251,29,32,51,229,42,6,64,205,10,6,225,167,237,82,33,19,64,48,11,235,126,35,237,160,18,24,190,33,6,64,94,35,86,229,235,35,205,10,6,205,194,3,225,253,203,25,110,32,12,114,43,115,24,163,205,194,5,237,
83,14,64,253,54,1,1,42,10,64,205,190,7,237,91,14,64,253,70,18,14,1,217,42,10,64,205,18,5,56,10,33,18,64,52,62,24,190,48,183,119,205,194,5,205,63,1,203,40,159,246,38,46,5,149,133,55,203,25,56,250,12,32,195,72,45,46,1,32,241,33,107,0,95,25,126,253,203,1,86,40,7,198,192,254,230,48,1,126,254,192,234,94,3,42,4,64,1,1,0,205,213,5,18,24,153,95,33,146,2,25,25,78,35,70,197,42,4,64,201,1,1,0,195,102,6,169,3,213,2,130,3,135,3,185,3,203,3,8,4,149,3,205,158,3,43,43,35,126,254,118,40,26,54,176,42,4,64,119,24,199,
205,158,3,43,205,108,3,24,190,237,91,10,64,26,254,176,192,209,24,179,42,6,64,205,10,6,235,205,194,3,33,7,64,195,229,2,17,0,0,24,245,235,17,186,3,126,230,192,32,247,86,35,94,201,14,0,237,91,10,64,217,42,6,64,205,10,6,205,194,3,122,179,202,131,2,43,205,191,6,43,205,36,6,35,35,11,11,217,213,217,209,62,176,18,19,229,33,34,0,25,9,237,114,48,169,225,237,176,237,83,12,64,195,147,2,42,21,64,124,181,32,152,42,4,64,205,108,3,42,10,64,34,38,64,205,26,0,253,203,25,110,32,24,205,121,6,217,124,181,194,186,4,43,
43,34,2,64,205,71,7,217,126,254,118,202,131,2,253,54,0,255,253,54,1,136,205,190,7,205,10,13,237,91,2,64,33,25,64,203,110,40,3,203,174,19,253,203,0,126,40,42,33,1,64,203,94,203,158,42,38,64,35,40,9,235,124,230,192,32,23,205,10,6,126,230,192,32,15,86,35,94,237,83,2,64,35,62,127,219,254,31,56,188,205,224,6,205,194,5,1,32,1,217,58,0,64,237,75,2,64,60,40,12,254,9,32,1,3,237,67,23,64,32,1,11,205,86,5,62,21,215,205,161,6,205,194,5,205,63,1,195,131,2,34,6,64,217,235,205,71,7,237,82,217,205,10,6,229,32,6,
205,36,6,205,102,6,217,35,68,77,125,214,3,180,196,79,9,225,48,21,197,43,205,213,5,19,42,12,64,43,193,11,237,184,42,6,64,235,114,35,115,195,131,2,237,75,6,64,205,28,6,22,151,40,5,17,0,0,203,19,126,254,64,220,191,6,208,35,122,215,208,253,203,1,198,237,75,21,64,167,237,66,32,4,62,184,215,200,9,126,35,254,176,40,18,254,192,234,89,5,56,5,205,132,5,24,3,205,89,5,208,24,218,253,203,1,86,32,1,60,215,24,243,123,7,15,216,24,16,175,9,60,56,252,237,66,61,40,240,30,28,131,167,40,4,253,203,1,134,217,103,23,23,
13,48,2,14,0,250,116,5,56,14,32,12,62,118,18,19,56,2,14,32,167,5,40,6,104,205,88,9,18,19,217,201,205,168,5,48,9,253,203,1,70,32,3,175,215,208,10,230,63,205,89,5,208,10,3,135,48,244,254,56,216,175,253,203,1,198,24,184,229,33,186,0,150,35,56,9,60,71,203,126,35,40,251,16,249,68,77,225,10,230,63,198,228,201,217,175,184,40,9,185,62,118,40,2,18,19,16,252,237,83,16,64,201,205,223,5,42,16,64,235,237,184,201,245,229,33,8,64,62,5,94,35,86,227,167,237,82,25,227,48,9,213,235,9,235,114,43,115,35,209,35,61,32,
232,235,209,241,167,237,82,68,77,3,25,235,201,229,33,40,64,84,93,193,235,205,28,6,208,197,205,36,6,24,244,126,184,192,35,126,43,185,201,229,126,135,250,53,6,56,23,35,62,118,35,71,237,177,24,29,1,2,0,56,1,72,23,23,35,126,48,251,24,12,230,64,62,1,40,230,35,126,35,6,0,79,3,9,9,209,167,237,82,68,77,25,235,201,42,10,64,43,237,91,8,64,205,83,6,197,120,47,71,121,47,79,3,205,223,5,235,225,25,213,237,176,225,201,126,217,33,0,0,68,214,28,56,23,254,10,48,19,79,62,13,188,48,1,103,84,93,41,41,25,41,9,217,223,
217,24,229,124,34,34,64,217,23,201,213,229,96,105,203,120,40,12,62,18,205,89,5,48,45,33,1,0,237,66,30,255,1,240,216,205,76,5,24,9,213,86,35,94,229,235,30,0,55,1,24,252,220,76,5,1,156,255,220,76,5,14,246,220,76,5,125,220,86,5,225,209,201,253,203,1,126,225,200,217,237,91,14,64,237,75,36,64,217,233,253,203,0,126,200,205,224,6,42,34,64,253,203,1,118,40,10,68,77,205,161,6,24,26,215,48,25,126,35,254,1,40,40,203,119,40,243,205,132,5,24,239,205,224,6,62,118,205,89,5,56,21,207,4,205,224,6,253,203,1,198,175,
215,48,243,217,121,217,61,230,7,32,244,217,235,237,67,36,64,34,14,64,34,16,64,201,42,12,64,54,118,35,1,33,23,24,234,79,44,100,63,89,43,23,75,54,78,16,94,93,42,45,90,97,59,24,77,13,17,68,76,49,80,1,227,2,6,0,52,9,6,213,5,185,8,6,0,67,9,0,46,9,0,101,9,4,227,6,214,5,196,8,4,0,249,8,5,114,9,1,0,154,9,4,218,6,217,0,211,12,5,74,8,3,61,9,3,86,2,6,216,5,209,9,3,35,9,0,6,2,0,182,1,0,48,9,0,91,6,0,71,7,5,68,8,43,34,38,64,33,0,0,0,34,21,64,33,25,64,203,110,40,7,203,190,70,223,195,137,8,203,254,231,205,121,6,
56,6,217,17,240,216,25,217,220,174,8,205,26,0,253,203,25,190,1,0,0,237,67,34,64,254,118,200,79,231,121,214,230,56,229,79,33,82,7,9,78,9,24,3,42,26,64,126,35,34,26,64,1,9,8,197,79,23,56,13,33,54,8,6,0,9,78,9,229,205,26,0,201,205,26,0,254,213,32,4,253,203,25,254,185,32,122,231,201,31,51,77,23,100,27,108,253,203,1,126,192,193,126,254,118,196,174,8,126,254,118,200,231,24,250,254,118,196,168,8,191,193,204,61,8,235,42,26,64,78,35,70,235,197,237,75,34,64,120,177,201,205,20,13,48,63,253,203,1,126,202,173,
10,34,32,64,253,203,1,190,205,173,10,253,203,1,254,201,193,253,70,1,197,239,209,1,61,12,58,1,64,203,127,32,204,170,230,64,196,174,8,24,165,34,32,64,205,20,13,48,8,223,201,239,253,203,1,118,192,58,21,64,253,182,22,192,34,21,64,201,32,6,253,203,1,126,32,137,195,232,7,197,205,168,8,193,205,61,8,42,34,64,229,205,61,12,193,253,203,0,126,200,197,43,203,126,203,254,35,35,32,7,1,4,0,35,205,213,5,35,209,115,35,114,35,237,91,2,64,19,115,35,114,201,42,32,64,205,59,11,253,203,0,126,200,235,43,43,203,126,40,22,
19,35,115,35,114,35,78,35,70,197,227,205,205,13,225,216,35,78,35,70,24,19,207,0,32,4,237,75,30,64,237,67,28,64,201,207,8,237,75,23,64,237,67,2,64,253,203,1,222,201,205,52,9,195,91,6,42,2,64,35,227,229,205,52,9,1,6,0,42,16,64,9,235,42,37,64,103,62,19,133,111,124,38,0,25,237,114,216,207,3,225,193,229,120,254,63,32,199,225,197,229,207,6,126,254,118,202,27,7,214,216,206,0,40,19,239,205,241,6,205,26,0,214,216,206,0,40,6,205,61,8,195,27,7,212,39,7,231,254,118,200,24,222,253,203,3,126,32,47,225,33,25,64,
203,238,203,182,58,1,64,230,64,1,2,0,32,2,14,4,182,119,247,208,54,118,121,15,15,56,3,18,43,119,43,54,176,58,37,64,60,50,18,64,195,247,2,207,7,197,239,209,205,61,8,58,34,64,253,203,0,126,200,18,201,72,197,205,24,13,56,60,1,0,9,81,89,214,220,40,38,27,6,4,60,40,32,60,40,34,254,39,32,16,253,203,1,182,35,34,34,64,223,61,40,23,254,117,32,248,205,174,8,217,1,0,0,24,53,213,197,231,24,199,205,73,0,24,22,223,24,19,254,38,56,5,205,173,10,24,10,205,121,6,220,174,8,253,203,1,246,205,26,0,217,1,0,0,214,220,56,
10,254,10,48,6,79,33,163,10,9,70,209,122,184,56,55,167,217,200,217,253,203,1,126,40,20,22,0,33,31,13,25,25,94,35,86,33,127,10,227,213,237,91,34,64,201,123,254,10,31,31,253,174,1,230,64,217,196,174,8,217,225,34,34,64,253,203,1,246,24,196,213,121,253,203,1,118,32,10,198,3,79,254,10,217,220,174,8,217,42,34,64,229,197,217,195,25,10,6,6,8,7,3,2,10,5,5,5,229,33,1,64,203,174,203,246,223,254,13,202,48,11,254,218,202,43,11,205,24,13,48,3,223,24,248,254,218,40,10,254,13,194,53,11,223,254,218,32,81,17,191,11,
225,229,78,205,85,0,19,26,185,40,247,230,63,185,32,5,62,218,190,40,11,26,167,40,53,19,23,48,248,19,24,224,213,205,73,0,209,227,33,1,64,26,174,230,64,32,31,203,238,203,246,26,230,63,254,13,32,2,203,182,203,126,225,200,33,186,11,229,235,35,94,35,86,213,42,34,64,201,225,195,174,8,205,73,0,24,5,253,203,1,182,223,225,253,203,1,126,200,78,35,126,229,254,218,32,25,197,237,75,38,64,197,205,37,0,225,34,38,64,193,33,0,64,203,126,32,19,54,2,225,201,203,169,254,13,40,9,203,241,205,24,13,56,2,203,233,42,8,64,
126,230,127,202,208,12,185,32,28,23,135,250,164,11,48,58,209,213,229,35,26,19,190,40,250,246,128,190,32,6,26,205,24,13,48,9,225,197,205,36,6,235,193,24,211,209,209,35,94,35,86,235,24,22,56,246,227,42,34,64,203,4,209,32,15,19,26,189,56,10,41,25,24,229,209,35,34,34,64,201,207,2,53,42,42,240,36,12,40,45,55,205,40,12,40,52,41,170,36,12,55,51,233,237,11,57,49,141,56,12,58,56,247,240,6,56,57,55,205,16,12,38,39,248,242,13,0,229,42,28,64,17,77,0,124,181,40,11,205,85,13,167,237,66,48,5,35,24,2,237,82,34,28,
64,209,205,85,13,96,105,35,201,217,1,7,0,247,48,29,213,217,68,77,205,161,6,217,62,1,18,225,201,110,38,0,201,1,2,0,125,247,48,5,54,1,43,119,201,33,48,12,201,126,61,200,35,201,253,203,0,126,200,197,42,32,64,205,59,11,33,0,64,126,254,2,40,209,23,253,203,1,118,56,59,54,255,40,71,42,32,64,1,2,0,3,35,126,205,24,13,56,248,254,218,40,98,247,48,177,213,42,32,64,11,11,11,27,120,177,62,64,40,8,237,176,126,246,128,18,62,96,225,205,185,12,235,27,225,235,114,43,115,201,32,248,225,205,164,12,42,34,64,43,205,36,
6,195,102,6,225,62,1,1,1,0,190,35,3,32,251,229,247,235,225,208,237,184,235,35,62,160,235,42,32,64,174,235,245,205,13,13,241,43,119,42,12,64,34,10,64,43,54,128,201,225,207,1,160,194,190,11,197,96,105,35,35,41,68,77,247,210,34,12,43,84,93,27,11,11,54,0,237,184,193,113,62,128,24,198,42,10,64,229,42,12,64,43,205,213,5,35,35,193,237,67,10,64,193,235,35,55,201,42,12,64,237,91,10,64,195,99,6,254,38,24,2,254,28,63,208,254,64,201,57,13,62,13,68,13,144,13,181,13,188,13,112,13,195,13,204,13,205,13,217,13,223,
13,222,13,167,237,82,24,3,167,237,90,224,207,5,205,237,13,197,8,205,85,13,32,63,193,8,31,208,195,246,13,68,77,62,16,33,0,0,41,203,17,203,16,48,4,25,48,1,3,61,32,242,124,230,128,176,177,201,203,122,32,206,175,205,242,13,163,8,197,66,75,235,33,1,0,11,203,120,32,200,197,205,85,13,193,40,244,193,24,178,122,179,40,174,205,237,13,197,31,237,106,124,77,33,0,0,6,16,237,106,237,82,48,1,25,203,17,23,16,244,103,105,35,193,216,24,65,124,162,103,125,163,111,201,124,178,103,125,179,111,201,167,237,82,33,255,255,
200,35,201,235,167,237,82,124,23,226,214,13,63,237,98,201,205,228,13,24,232,235,205,228,13,24,242,26,190,192,61,200,19,35,24,247,175,205,241,13,235,203,124,200,60,8,124,47,103,125,47,111,35,8,201,0,0,0,0,0,0,0,0,0,20,20,0,0,0,0,0,240,240,240,240,240,240,240,240,0,0,0,0,255,255,255,255,240,240,240,240,0,0,0,0,15,15,15,15,0,0,0,0,0,0,0,0,240,240,240,240,0,0,0,0,15,15,15,15,15,15,15,15,240,240,240,240,170,85,170,85,170,85,170,85,0,0,0,0,170,85,170,85,170,85,170,85,0,0,0,0,0,30,33,120,32,32,127,0,0,8,
62,72,62,9,62,8,0,0,0,8,0,0,8,0,0,62,65,6,8,0,8,0,0,4,8,8,8,8,4,0,0,16,8,8,8,8,16,0,0,0,0,0,62,0,0,0,0,0,8,8,62,8,8,0,0,0,42,28,8,28,42,0,0,0,2,4,8,16,32,0,0,0,0,62,0,62,0,0,0,0,16,8,4,8,16,0,0,0,4,8,16,8,4,0,0,0,8,0,0,8,8,16,0,0,0,0,0,8,8,16,0,0,0,0,0,12,12,0,0,28,34,65,65,34,28,0,0,12,20,4,4,4,30,0,0,62,65,1,62,64,127,0,0,62,65,6,1,65,62,0,0,12,20,36,68,127,4,0,0,127,64,126,1,65,62,0,0,62,64,126,65,65,62,0,0,127,1,2,4,8,8,0,0,62,65,62,65,65,62,0,0,62,65,65,63,1,62,0,0,62,65,65,127,65,65,0,0,126,
65,126,65,65,126,0,0,30,33,64,64,33,30,0,0,124,66,65,65,66,124,0,0,127,64,124,64,64,127,0,0,127,64,124,64,64,64,0,0,30,33,64,71,33,30,0,0,65,65,127,65,65,65,0,0,62,8,8,8,8,62,0,0,2,2,2,66,34,28,0,0,66,68,120,68,66,65,0,0,64,64,64,64,64,127,0,0,65,99,85,73,65,65,0,0,97,81,73,69,67,65,0,0,62,65,65,65,65,62,0,0,126,65,65,126,64,64,0,0,62,65,65,73,69,62,0,0,126,65,65,126,68,66,0,0,62,64,62,1,65,62,0,0,127,8,8,8,8,8,0,0,65,65,65,65,65,62,0,0,65,65,65,34,20,8,0,0,65,65,65,73,85,34,0,0,33,18,12,12,18,33,
0,0,65,34,28,8,8,8,0,0,127,2,4,8,16,127,0];
zx.zx80=function(surface,scale){zx.system=this;zx.system.surface=surface;this.memory=Array.apply(null,Array(16*1024)).map(function(x,i){return 0});this.rom=zx.rom;this.mosaic=zx.mosaic;zx.peek=function(addr){addr=addr&65535;if(addr<4*1024)return this.rom[addr];return this.memory[addr-4*1024]}.bind(this);zx.poke=function(addr,value){var ram_at=4*1024;addr=addr&65535;if(addr>=ram_at)this.memory[addr-ram_at]=value}.bind(this);zx.usr=function(value){};zx.code=function(character){var ascii=sgxASCII(character);
if(ascii>=256)return ascii;ascii-=32;if(ascii<0||ascii>=this.mapASCII2ZX.length)ascii=15;var chr=this.mapASCII2ZX[ascii];return chr|256}.bind(this);zx.chr$=function(code){return sgxToCharacter(code|256)};zx.inverse=function(text){var output="";for(var i=0;i<text.length;++i)output+=zx.chr$(zx.code(text[i])+128);return output}.bind(this);this.scale=scale||1;this.timecum=0;this.zxWidth=32;this.zxHeight=24;this.zxWidthPixels=32*8;this.zxHeightPixels=24*8;var zxwidth=this.zxWidth*8*this.scale;var zxheight=
this.zxHeight*8*this.scale;this.screenRC=new sgxRect2f;this.screenRC.top=(surface.getHeight()-zxheight)/2;this.screenRC.left=(surface.getWidth()-zxwidth)/2;this.screenRC.right=this.screenRC.left+zxwidth;this.screenRC.bottom=this.screenRC.top+zxheight;this.border=[];this.border[0]=new sgxRect2f(0,0,surface.getWidth(),this.screenRC.top);this.border[1]=new sgxRect2f(0,this.screenRC.top,this.screenRC.left,surface.getHeight()-this.screenRC.top);this.border[2]=new sgxRect2f(this.screenRC.left+zxwidth,this.screenRC.top,
surface.getWidth()-(this.screenRC.left+zxwidth),surface.getHeight()-this.screenRC.top);this.border[3]=new sgxRect2f(this.screenRC.left,this.screenRC.top+zxheight,zxwidth,surface.getHeight()-(this.screenRC.top+zxheight));var NIL=15;this.mapASCII2ZX=[0,NIL,1,12,13,NIL,NIL,NIL,16,17,20,19,26,18,27,21,28,29,30,31,32,33,34,35,36,37,14,25,24,22,23,15,NIL,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,NIL,NIL,NIL,NIL,NIL,NIL,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,
54,55,56,57,58,59,60,61,62,63,NIL,NIL,NIL,NIL,NIL];this.gfxBlack=zx.udg([0,0,0,0,0,0,0,0]);this.palette=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]];this.font=[];for(var i=0;i<64;++i){this.font[i]=zx.Texture.create8x8(this.rom,3584+i*8);this.font[i+128]=zx.Texture.create8x8(this.rom,3584+i*8,true)}this.screen=new zx.screen(this);this.audio=new zx.audio(this)};zx.zx80.prototype.cls=function(){this.surface.setFillColor(sgxColorRGBA.White);this.surface.setFillTexture(NULL);this.surface.fillRect(this.screenRC)};
zx.zx80.prototype.updateCharacter=function(chr,udg){};zx.zx80.prototype.getCharacterWidth=function(chr){var t=this.getCharacterTexture(chr);return t?t.getWidth():0};zx.zx80.prototype.getCharacterHeight=function(chr){var t=this.getCharacterTexture(chr);return t?t.getHeight():0};zx.zx80.prototype.getCharacterTexture=function(chr){if(chr<256)chr=this.mapASCII2ZX[chr-32];else chr=chr-256;var texture=this.font[chr];if(chr<0|chr>=this.font.length||!this.font[chr])return this.font[15];return this.font[chr]};
zx.zx80.prototype.drawCharacter=function(chr,attr,x,y){return this.drawWith(this.getCharacterTexture(chr),attr,x,y)};
zx.zx80.prototype.drawWith=function(gfx,attr,x,y){if(gfx===undefined||attr===undefined)return;var switch_colours=attr.flash&&this.flashPulse!=attr.inverse;var width=gfx.paper.getWidth();var height=gfx.paper.getHeight();var rc=new sgxRect2f(this.screenRC.left+x*this.scale,this.screenRC.top+y*this.scale,width*this.scale,height*this.scale);this.surface.setClipRect(this.screenRC);this.surface.setFillColor(sgxColorRGBA.Black);this.surface.setFillTexture(gfx.ink);this.surface.fillRect(rc)};
zx.zx80.prototype.draw=function(surface){this.surface.setFillColor(sgxColorRGBA.White);this.surface.setFillTexture(NULL);this.surface.setClipRect(NULL);for(var i=0;i<4;++i)this.surface.fillRect(this.border[i])};
zx.zx80.prototype.plot=function(x,y){this.surface.setClipRect(this.screenRC);if(x>=0&&y>=0&&x<64&&y<44){var rc=new sgxRect2f;rc.left=this.toX(sgxFloor(x)*4);rc.top=this.toY(sgxFloor(44-y)*4);rc.right=rc.left+4*this.scale;rc.bottom=rc.top+4*this.scale;this.surface.setFillTexture(this.font[64].ink);this.surface.fillRect(rc)}};zx.zx80.prototype.drawPoint=function(x,y){};zx.zx80.prototype.toX=function(x){return this.screenRC.left+x*this.scale};
zx.zx80.prototype.toY=function(y){return this.screenRC.top+y*this.scale};zx.zx80.prototype.drawLineWith=function(attr,x1,y1,x2,y2){};zx.zx80.prototype.drawLine=function(x1,y1,x2,y2){};zx.zx80.prototype.circle=function(x,y,r){};zx.zx80.prototype.update=function(telaps){};zx.zx80.prototype.getRGB=function(index,bright){};zx.zx80.prototype.setBorderColor=function(colour){};zx.zx80.prototype.setInkColor=function(colour){};zx.zx80.prototype.setPaperColor=function(colour){};
zx.zx80.prototype.setBright=function(bright){};zx.zx80.prototype.setFlash=function(flash){};zx.Texture=function(width,height,data,offset,inverse){this.ink=this.createtexture(width,height,1,data,offset,inverse);this.paper=this.createtexture(width,height,0,data,offset,inverse)};zx.Texture.create8x8=function(data,offset,inverse){return new zx.Texture(8,8,data,offset,inverse)};zx.Texture.create16x16=function(data,offset,inverse){return new zx.Texture(16,16,data,offset,inverse)};
zx.Texture.prototype.getWidth=function(){return this.ink.getWidth()};zx.Texture.prototype.getHeight=function(){return this.ink.getHeight()};
zx.Texture.prototype.createtexture=function(width,height,ink_not_paper,data,offset,inverse){var texture=sgx.graphics.TextureManager.get().create("",width,height);var imageData=[];texture.lock(imageData);var bitmap=imageData.pBitmap_;var bit=0;var shift=7;var xpos=0;var pi=0;var setbit=inverse?0:1;var clrbit=inverse?1:0;var idx=offset-1;for(var i=0;i<width*height;++i){bit>>=1;if(bit==0){bit=128;++idx}var isset=data[idx]&bit?setbit:clrbit;bitmap[pi+0]=bitmap[pi+1]=bitmap[pi+2]=isset==ink_not_paper?
255:0;bitmap[pi+3]=isset==ink_not_paper?255:0;pi+=4}texture.unlock(imageData);texture.clearRegions();texture.addPixelRegion(0,0,width,height);return texture};zx.TO="TO";zx.SEMICOLON=";";zx.bin=function(binary){if(binary.substring(0,1)=="%")binary=binary.substring(1);return parseInt(binary,2)};zx.hex=function(hex){if(hex.substring(0,2)=="0x"||hex.substring(0,2)=="0X")hex=hex.substring(2);else if(hex.substring(0,1)=="$"||hex.substring(0,1)=="#")hex=hex.substring(1);return parseInt(binary,16)};
zx.pause=function(seconds){var currentTime=(new Date).getTime();while(currentTime+1E3*seconds>=(new Date).getTime());};zx.inkey$=function(){return""};zx.copy=function(){};zx.abs=function(v){return sgxAbs(v)};zx.acs=function(v){return sgxACos(v)};zx.asn=function(v){return sgxASin(v)};zx.atn=function(v){return sgxAtan(v)};zx.code=function(v){if(v===undefined||v=="")return 0;return sgxASCII(v[0])};zx.cos=function(v){return sgxCos(v)};zx.ln=function(v){return sgxLn(v)};
zx.randomize=function(v){sgxRand(v===undefined?0:v)};zx.rnd=function(){return sgxRand()};zx.sgn=function(v){return sgxSgn(v)};zx.sqr=function(v){return sgxSqr(v)};zx.sin=function(v){return sgxSin(v)};zx.pi=function(){return SGX_PI};zx["int"]=function(v){return sgxFloor(v)};zx.exp=function(v){return sgxExp(v)};zx.code=function(character){return sgxASCII(character)};zx.chr$=function(code){return sgxToCharacter(code)};zx.inkey$=function(){return""};zx.len=function(v){return sgxStrlen(v)};zx.val=function(v){return sgxAtoi(v)};
zx.val$=function(v){return""+sgxAtoi(v)};zx.str$=function(v){return sgxToCharacter(v)};zx.$=function(value,a,b,c){if(a===undefined)return value;if(a===zx.TO){first=0;if(b===undefined)return value;else return value.substr(0,b)}else if(b===undefined)return value.substr(a,1);else if(b!=zx.TO)return value.substr(a,b-a);else if(c===undefined)return value.substr(a);else return value.substr(a,c-a);return""};
zx.udg=function(a,b,c,d,e,f,g,h){if(Object.prototype.toString.call(a)==="[object Array]"){if(b===undefined)b=0;return zx.Texture.create8x8(a,b)}else return zx.Texture.create8x8([a,b,c,d,e,f,g,h],0)};function zxAttribute(attr){this.ink=attr&7;this.paper=(attr&56)>>3;this.bright=attr&64?1:0;this.flash=attr&128;this.inverse=false;this.inkColor=new sgxColorRGBA;this.paperColor=new sgxColorRGBA;this.recompute()}zxAttribute.prototype.setBright=function(state){this.bright=state?1:0;this.recompute()};
zxAttribute.prototype.setInk=function(color){this.ink=color&7;this.recompute()};zxAttribute.prototype.setPaper=function(color){this.paper=color&7;this.recompute()};zxAttribute.prototype.setFlash=function(flash){this.flash=flash?true:false};zxAttribute.prototype.recompute=function(){this.inkColor=new sgxColorRGBA(zx.system.palette[this.ink][this.bright]);this.paperColor=new sgxColorRGBA(zx.system.palette[this.paper][this.bright])};
zx.audio=function(system){this.system=system;this.audioCtx=new (window.AudioContext||window.audioContext||window.webkitAudioContext);zx.beep=this.beep.bind(this)};
zx.audio.prototype.beep=function(duration,pitch){var oscillator=this.audioCtx.createOscillator();var gainNode=this.audioCtx.createGain();oscillator.connect(gainNode);gainNode.connect(this.audioCtx.destination);var key=pitch+60;var frequency=440*Math.pow(2,(key-69)/12);var volume=undefined;var callback=undefined;var type;if(volume)gainNode.gain.value=volume;if(frequency)oscillator.frequency.value=frequency;if(type)oscillator.type=type;if(callback)oscillator.onended=callback;oscillator.start();zx.pause(duration*
.9);oscillator.stop();zx.pause(duration*.1);return this};zx.screen=function(system){this.system=system;this.afile=[];this.scrfile=[];for(var i=0;i<32*24;++i){this.afile.push(0);this.scrfile.push("")}this.state={};this.currentAttribute=new zxAttribute(7);this.ink(zx.WHITE);this.paper(zx.BLACK);this.cls()};zx.screen.prototype.drawWith=function(gfx,attr,x,y){this.system.drawWith(gfx,attr,x,y)};
zx.screen.prototype.setAttribute=function(attr,x,y){if(typeof attr==="zx.attribute")this.afile[x+y*32]=attr;else this.afile[x+y*32]=new zxAttribute(attr)};zx.screen.prototype.setScreen=function(chr,x,y){this.scrfile[x+y*32]=chr};zx.screen.prototype.cls=function(){this.system.cls();for(var y=0;y<24;++y)for(var x=0;x<24;++x){this.setAttribute(new zxAttribute(7),x,y);this.setScreen(" ",x,y)}this.lastX=this.lastY=0;this.lastPrintX=this.lastPrintY=0};
zx.screen.prototype.border=function(colour){this.system.setBorderColor(colour);return this};zx.screen.prototype.ink=function(ink){this.system.setInkColor(ink);this.currentAttribute.setInk(ink);return this};zx.screen.prototype.paper=function(paper){this.system.setPaperColor(paper);this.currentAttribute.setPaper(paper);return this};zx.screen.prototype.bright=function(bright){this.system.setBright(bright);this.currentAttribute.setBright(bright);return this};
zx.screen.prototype.flash=function(flash){this.system.setFlash(flash);this.currentAttribute.setFlash(flash);return this};zx.screen.prototype.plot=function(x,y){var nx=sgxFloor(x/8);var ny=sgxFloor(y/8);this.setScreen("",nx,ny);this.system.plot(x,y);this.lastX=x;this.lastY=y};zx.screen.prototype.draw=function(x,y){this.system.drawLineWith(this.currentAttribute,this.lastX,this.lastY,this.lastX+x,this.lastY+y);this.lastX+=x;this.lastY+=y};
zx.screen.prototype.circle=function(x,y,r){this.system.drawCircle(x,y,r);this.lastX=x;this.lastY=y};zx.screen.prototype.print=function(text,flags){this.printAt(this.lastPrintY/8,this.lastPrintX/8,text,flags);return this};zx.screen.prototype.printAt=function(y,x,text,flags){this.printFineAt(y*8,x*8,text);if(flags!=zx.SEMICOLON){this.lastPrintX=0;this.lastPrintY+=8}return this};
zx.screen.prototype.printFineAt=function(ypos,xpos,text){if(!text)return;var length=text.length;var x=xpos;var y=ypos;for(var i=0;i<text.length;++i){var chr=zx.code(text[i]);this.system.drawCharacter(chr,this.currentAttribute,x,y);var width=this.system.getCharacterWidth(chr);x+=width;if(x>=256){x-=256;y+=this.system.getCharacterHeight(chr);if(x&&x<width)this.system.drawCharacter(chr,this.currentAttribute,x-width,y)}}this.lastPrintX=x;this.lastPrintY=y;return this};
zx.screen.prototype.tab=function(column){if(column*8<this.lastPrintX){this.lastPrintX=0;this.lastPrintY+=8}var spacing=column%31-this.lastPrintX/8;var spaces=" ".repeat(spacing);this.print(spaces,zx.SEMICOLON);return this}; 
